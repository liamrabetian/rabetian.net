<!DOCTYPE html>
<html lang="en-US">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Eike Rabetian floating on the web">
<meta name="keywords" content="python,blog,software,engineer,developer">

<base href="/">

<title>Eike Rabetian</title>

<meta name="generator" content="Hugo 0.40.1" />





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400|Roboto+Slab:400,700|Roboto:300,300i,400,400i,500,500i,700,700i">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/main.css">




<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

</head>
<body lang="en-US">
<div class="container">


<header class="row text-left title">
  <h1 class="title">How To Count Your Postgres Tables In Django</h1>
</header>
<section id="category-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-left meta">
      PUBLISHED ON 17.11.2020
      
      
      
      —
      
      
      <a class="meta" href="/categories/database">DATABASE</a>, 
      
      <a class="meta" href="/categories/python">PYTHON</a>
      
      
      
    </h6>
  </div>
  
</section>
<section id="content-pane" class="row">
  <div class="col-md-12 text-justify content">
    <p>When you want to do a full count on your tables in django, you often do it like this:</p>

<pre><code class="language-python">MyModel.objects.count()
</code></pre>

<p>which will produce a sql like this:</p>

<pre><code class="language-sql">SELECT COUNT(*) AS &quot;__count&quot; FROM &quot;myapp_mymodel&quot;
</code></pre>

<p>Which is pretty fine most of the time, but what happens if you have a lot of data and rows on your table? Then for instance in my experience it took 20 seconds to count all the rows in a table!! especially if you have a more complex query for your counts.</p>

<p>There&rsquo;s an option in postgres called estimate counts, which will give you well, an estimate for your counts! So unless you want a very precise number of counts from your table, you&rsquo;re better off this way:</p>

<p>The sql query would be like this:</p>

<pre><code class="language-sql">SELECT reltuples as approximate_row_count FROM pg_class WHERE relname = 'table_name';
</code></pre>

<p>Now what I needed was a function which receives a custom query and gives me back the approximate row counts. One smart person called Michael Fuhr has come up with this function to achieve this. So for more sophisticated queries you can use this function:</p>

<pre><code class="language-sql">CREATE FUNCTION count_estimate(query text) RETURNS integer AS
$func$
DECLARE
    rec   record;
    rows  integer;
BEGIN
    FOR rec IN EXECUTE 'EXPLAIN ' || query LOOP
        rows := substring(rec.&quot;QUERY PLAN&quot; FROM ' rows=([[:digit:]]+)');
        EXIT WHEN rows IS NOT NULL;
    END LOOP;

    RETURN rows;
END
$func$ LANGUAGE plpgsql;
</code></pre>

<p>You first have to create this function in your postgres database and use it like this:</p>

<pre><code class="language-sql">SELECT count_estimate('Your custom query here');
</code></pre>

<p>Now what I&rsquo;ve done in django to achieve all this is that at first I made sure I&rsquo;m gonna create this stored procedure in my database by creating it in a migration.</p>

<pre><code class="language-python">./manage.py makemigrations --empty myapp -n count_estimate_procedure
</code></pre>

<pre><code class="language-python"># Generated by Django 2.2.11 on 2020-11-17 15:30

from django.db import migrations

STORED_PROCEDURE_SQL = &quot;&quot;&quot;
CREATE FUNCTION count_estimate(query text) RETURNS integer AS
$func$
DECLARE
    rec   record;
    rows  integer;
BEGIN
    FOR rec IN EXECUTE 'EXPLAIN ' || query LOOP
        rows := substring(rec.&quot;QUERY PLAN&quot; FROM ' rows=([[:digit:]]+)');
        EXIT WHEN rows IS NOT NULL;
    END LOOP;

    RETURN rows;
END
$func$ LANGUAGE plpgsql;
&quot;&quot;&quot;


class Migration(migrations.Migration):

    dependencies = [
        (&quot;myapp&quot;, &quot;0005_some_other_migration_file&quot;),
    ]

    operations = [
        migrations.RunSQL(
            (STORED_PROCEDURE_SQL), (&quot;DROP FUNCTION IF EXISTS count_estimate;&quot;)
        )
    ]
</code></pre>

<p>and then create a helper function to call this stored procedure from django:</p>

<pre><code class="language-python">def estimate_count_fast(sql):
    &quot;&quot;&quot; postgres really sucks at full table counts, this is a faster version&quot;&quot;&quot;
    cursor = connection.cursor()
    cursor.execute(sql)
    row = cursor.fetchone()
    return int(row[0])
</code></pre>

<p>Now you just have to write your count sql and give it to this function, in my case it was something like this:</p>

<pre><code class="language-python">MYMODEL_COUNT_SQL = &quot;&quot;&quot;
SELECT count_estimate('SELECT * FROM myapp_mymodel 
WHERE NOT (&quot;myapp_mymodel&quot;.&quot;id&quot; IN (SELECT U0.&quot;id&quot; FROM &quot;myapp_mymodel&quot; U0 
LEFT OUTER JOIN &quot;myanotherapp_myanothermodel&quot; U1 ON (U0.&quot;id&quot; = U1&quot;mymodel_id&quot;) 
WHERE U1.&quot;somemodel_id&quot; IS NULL))');
&quot;&quot;&quot;
</code></pre>

<p>Now it might not be a pretty sql, but you get my point. Don&rsquo;t you?!</p>

<p>And use this query in my helper function:</p>

<pre><code class="language-python">estimate_count_fast(MYMODEL_COUNT_SQL)
</code></pre>

<p>And that&rsquo;s pretty much it. Wish you a very fast performant system!</p>

  </div>
</section>
<section id="tag-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-right meta">
      
      
      
      TAGS:
      
      
      <a class="meta" href="/tags/database">DATABASE</a>, 
      
      <a class="meta" href="/tags/django">DJANGO</a>, 
      
      <a class="meta" href="/tags/engineering">ENGINEERING</a>, 
      
      <a class="meta" href="/tags/python">PYTHON</a>
      
      
      
    </h6>
  </div>
  
</section>








<section id="menu-pane" class="row menu text-center">
  
  
  <span><a class="menu-item" href="/blog/third/">&lt; prev | </a></span>
  
  
  <span><a class="menu-item" href="/blog">blog</a></span>
  
  
  
  <h4 class="text-center"><a class="menu-item" href="/">home</a></h4>
</section>



<footer class="row text-center footer">
  <hr />
  
  <h6 class="text-center copyright">© 2020. Eike Rabetian. All rights reserved.</h6>
  
  <h6 class="text-center powered">Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/shenoybr/hugo-goa">Goa</a>.</h6>
  
  
</footer>

</div>






<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="js/main.js"></script>
</body>
</html>


